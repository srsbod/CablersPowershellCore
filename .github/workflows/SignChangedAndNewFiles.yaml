name: Sign Changed and New PowerShell Scripts

on:
  #push:
  #  branches: [master, main]
  #pull_request:
  #  types: [closed]
  #  branches: [master, main]
  workflow_dispatch:

jobs:
  sign-changed-files:
    runs-on: windows-latest
    # Only run on direct commits, merged PRs, or manual triggers
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Full history needed to identify changed files

      - name: Setup certificate
        id: setup-cert
        shell: pwsh
        run: |
          # Create certificate directory
          New-Item -ItemType Directory -Path cert -Force

          # Decode and save certificate
          $certBytes = [Convert]::FromBase64String('${{ secrets.CODE_SIGNING_CERT }}')
          $certPath = Join-Path -Path cert -ChildPath cert.pfx
          [System.IO.File]::WriteAllBytes($certPath, $certBytes)

          # Import certificate
          $securePassword = ConvertTo-SecureString -String '${{ secrets.CODE_SIGNING_PASS }}' -AsPlainText -Force
          Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePassword

          # Get thumbprint for signing
          $cert = Get-PfxCertificate -FilePath $certPath -Password $securePassword
          $thumbprint = $cert.Thumbprint
          Write-Output -InputObject "CERT_THUMBPRINT=$thumbprint" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Identify and sign changed PowerShell files
        shell: pwsh
        run: |
          $thumbprint = '${{ steps.setup-cert.outputs.CERT_THUMBPRINT }}'
          $signerCert = Get-Item "Cert:\CurrentUser\My\$thumbprint"
          $filesToSign = @()
          $signedCount = 0

          # Determine which files to check based on the event type
          if ($env:GITHUB_EVENT_NAME -eq 'pull_request') {
            # For PRs, compare the PR base to the current commit
            $changedFiles = git diff --name-only $env:GITHUB_BASE_REF..HEAD | Where-Object { $_ -match '\.(ps1|psm1|psd1)$' }
          } 
          elseif ((git rev-list --count HEAD) -gt 1) {
            # For regular commits, check files changed in this commit
            if ($env:GITHUB_EVENT_NAME -eq 'push') {
              # For push events to branches, get the files changed in the pushed commits
              $beforeSha = '${{ github.event.before }}'
              $afterSha = '${{ github.event.after }}'
              $changedFiles = git diff --name-only $beforeSha $afterSha | Where-Object { $_ -match '\.(ps1|psm1|psd1)$' }
            } else {
              # Fallback to comparing with the previous commit
              $changedFiles = git diff --name-only HEAD^ HEAD | Where-Object { $_ -match '\.(ps1|psm1|psd1)$' }
            }
          } 
          else {
            # For first commit, get all files
            $changedFiles = git ls-tree --name-only -r HEAD | Where-Object { $_ -match '\.(ps1|psm1|psd1)$' }
          }

          Write-Output -InputObject "Found $($changedFiles.Count) changed PowerShell files to check"

          foreach ($file in $changedFiles) {
            if (Test-Path $file) {
              $filesToSign += $file
              Write-Output -InputObject "Added to signing queue: $file"
            }
          }

          # Sign all changed files
          foreach ($file in $filesToSign) {
            Write-Output -InputObject "Signing $file"
            Set-AuthenticodeSignature -FilePath $file -Certificate $signerCert -TimestampServer "http://timestamp.digicert.com"
            $signedCount++
          }

          Write-Output -InputObject "Signed $signedCount files"
          Write-Output -InputObject "SIGNED_COUNT=$signedCount" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Verify signatures
        shell: pwsh
        run: |
          $failedFiles = @()

          foreach ($file in $filesToSign) {
            $signature = Get-AuthenticodeSignature -FilePath $file
            if ($signature.Status -ne 'Valid') {
              $failedFiles += $file
              Write-Output -InputObject "Signature verification failed for $file"
            }
          }

          if ($failedFiles.Count -gt 0) {
            Write-Output -InputObject "Signature verification failed for $($failedFiles.Count) files"
            exit 1
          }

      - name: Remove certificate
        shell: pwsh
        run: |
          $thumbprint = '${{ steps.setup-cert.outputs.CERT_THUMBPRINT }}'
          Remove-Item -Path "Cert:\CurrentUser\My\$thumbprint"

      - name: Commit signed files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Sign ${{ env.SIGNED_COUNT }} changed PowerShell files" -a || echo "No changes to commit"
          git push
