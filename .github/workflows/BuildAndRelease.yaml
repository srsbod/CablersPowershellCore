name: Build and Release Module

on:
  push:
    branches: [master, main]
    paths:
      - "**/*.psd1"

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get Module Version
        id: get-version
        shell: pwsh
        run: |
          $ModuleManifestPath = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Filter "CablersPowershellCore.psd1" -Recurse | 
                                Select-Object -First 1 -ExpandProperty FullName

          $ModuleInfo = Import-PowerShellDataFile -Path $ModuleManifestPath
          $Version = $ModuleInfo.ModuleVersion

          Write-Output -InputObject "Module version: $Version"
          "VERSION=$Version" >> $env:GITHUB_OUTPUT

      - name: Check Version Change
        id: check-version
        shell: pwsh
        run: |
          # Get latest release version
          try {
            $LatestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/${env:GITHUB_REPOSITORY}/releases/latest" -ErrorAction Stop
            $LatestVersion = $LatestRelease.tag_name -replace '^v', ''
            Write-Output -InputObject "Latest release version: $LatestVersion"
          }
          catch {
            # No releases yet or other error
            $LatestVersion = "0.0.0"
            Write-Output -InputObject "No previous releases found or error occurred, using version 0.0.0 as baseline"
          }

          # Compare with current version
          $CurrentVersion = "${{ steps.get-version.outputs.VERSION }}"
          Write-Output -InputObject "Current module version: $CurrentVersion"

          $VersionChanged = [System.Version]$CurrentVersion -gt [System.Version]$LatestVersion
          Write-Output -InputObject "Version changed: $VersionChanged"

          If (-not $VersionChanged) {
            Write-Output -InputObject "No version change detected. Skipping release."
            exit 0
          } else {
            "VERSION_CHANGED=$VersionChanged" >> $env:GITHUB_OUTPUT
          }

      - name: Get commit history
        id: get-history
        shell: pwsh
        run: |
          # Find the latest tag (excluding the current one we're creating)
          $LatestTag = git tag --sort=-creatordate | Select-Object -First 1  
          if (-not $LatestTag) {
            # If no previous tag exists, get all commits
            $RawCommitHistory = git log --pretty=format:"- %s (%h)" --abbrev-commit
            Write-Output -InputObject "No previous tag found. Using all commit history."
          } else {
            # Get commits between latest tag and HEAD
            $RawCommitHistory = git log "$LatestTag..HEAD" --pretty=format:"- %s (%h)" --abbrev-commit
            Write-Output -InputObject "Found previous tag: $LatestTag"
          }  
          # Filter out signing commits
          $CommitLines = $RawCommitHistory -split "`n"
          $FilteredCommits = $CommitLines | Where-Object { $_ -notmatch "- Sign \d+ new/unsigned PowerShell files" }
          $CommitHistory = $FilteredCommits -join "`n"  
          if ([string]::IsNullOrWhiteSpace($CommitHistory)) {
            $CommitHistory = "- No changes detected since last release"
          }  
          # Convert the commit history to a format suitable for GitHub Actions output
          $CommitHistoryFormatted = $CommitHistory -replace "`n", "%0A"
          "COMMIT_HISTORY<<EOF" >> $env:GITHUB_OUTPUT
          "$CommitHistoryFormatted" >> $env:GITHUB_OUTPUT
          "EOF" >> $env:GITHUB_OUTPUT

      - name: Create build package
        id: create-package
        shell: pwsh
        run: |
          $BuildDir = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath "build\CablersPowershellCore"
          New-Item -Path $BuildDir -ItemType Directory -Force

          # Define exclusion patterns
          $ExcludePatterns = @(
            "^\..*"      # Files/folders starting with .
          )

          # Get all files to copy
          $Files = Get-ChildItem -Path $env:GITHUB_WORKSPACE -Recurse -File

          # Initialize counters
          $IncludedCount = 0
          $ExcludedCount = 0
          $ExcludedFiles = @()

          Write-Output -InputObject "Starting to process files for packaging..."

          foreach ($File in $Files) {
            $RelativePath = $File.FullName.Substring("$($env:GITHUB_WORKSPACE)\".Length)
            $Excluded = $false

            foreach ($Pattern in $ExcludePatterns) {
              if ($RelativePath -match $Pattern) {
                $Excluded = $true
                $ExcludedFiles += $RelativePath
                $ExcludedCount++
                Write-Output -InputObject "EXCLUDED: $RelativePath (matches pattern: $Pattern)"
                break
              }
            }

            if (-not $Excluded) {
              $DestPath = Join-Path -Path $BuildDir -ChildPath $RelativePath
              $DestDir = Split-Path -Path $DestPath -Parent
              
              if (-not (Test-Path -Path $DestDir)) {
                New-Item -Path $DestDir -ItemType Directory -Force | Out-Null
              }
              
              Copy-Item -Path $File.FullName -Destination $DestPath -Force
              $IncludedCount++
              Write-Output -InputObject "INCLUDED: $RelativePath"
            }
          }

          # Output summary
          Write-Output -InputObject "`nPackaging Summary:"
          Write-Output -InputObject "  - Total files processed: $($IncludedCount + $ExcludedCount)"
          Write-Output -InputObject "  - Files included in package: $IncludedCount"
          Write-Output -InputObject "  - Files excluded from package: $ExcludedCount"

          if ($ExcludedCount -gt 0) {
            Write-Output -InputObject "`nExclusion patterns used:"
            foreach ($Pattern in $ExcludePatterns) {
              Write-Output -InputObject "  - $Pattern"
            }
          }

          # Create zip file
          $ZipName = "CablersPowershellCore-${{ steps.get-version.outputs.VERSION }}.zip"
          $ZipPath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath $ZipName
          Compress-Archive -Path "$BuildDir\*" -DestinationPath $ZipPath -Force

          Write-Output -InputObject "`nCreated package: $ZipPath"
          "ZIP_PATH=$ZipPath" >> $env:GITHUB_OUTPUT

      - name: Publish to PowerShell Gallery
        if: ${{ secrets.PS_GALLERY_API_KEY != '' }}
        shell: pwsh
        env:
          PS_GALLERY_API_KEY: ${{ secrets.PS_GALLERY_API_KEY }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:PS_GALLERY_API_KEY)) {
              Write-Output "PS_GALLERY_API_KEY secret is not configured. Skipping publish to PowerShell Gallery."
              exit 0
          }

          $repository = 'PSGallery'
          $modulePath = Join-Path -Path $env:GITHUB_WORKSPACE -ChildPath 'build/CablersPowershellCore'

          if (-not (Get-PSRepository -Name $repository -ErrorAction SilentlyContinue)) {
              Register-PSRepository -Name $repository -SourceLocation 'https://www.powershellgallery.com/api/v2/' -InstallationPolicy Trusted
              Write-Output "Registered PSGallery repository"
          }
          else {
              Set-PSRepository -Name $repository -InstallationPolicy Trusted
          }

          try {
              Publish-Module -Path $modulePath -Repository $repository -NuGetApiKey $env:PS_GALLERY_API_KEY -Force -ErrorAction Stop
              Write-Output "Published CablersPowershellCore to PowerShell Gallery."
          }
          catch {
              Write-Output "PowerShell Gallery publish failed: $($_.Exception.Message)"
              throw
          }

      - name: Create Release
        if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get-version.outputs.VERSION }}
          tag_name: v${{ steps.get-version.outputs.VERSION }}
          files: ${{ steps.create-package.outputs.ZIP_PATH }}
          body: |
            # Release of CablersPowershellCore v${{ steps.get-version.outputs.VERSION }}

            This release was automatically created by the GitHub Actions workflow.

            ## Changes in this version

            ${{ steps.get-history.outputs.COMMIT_HISTORY }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
